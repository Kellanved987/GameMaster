# launcher.py

import streamlit as st
from sqlalchemy.orm import sessionmaker, Session as DBSession
from sqlalchemy import desc

from db.engine import get_engine
from db.schema import Session as SessionModel, Turn
from session_zero import run_session_zero_turn
# Import the new single-turn function
from game_loop import run_game_turn 

# --- Configuration and Setup ---
SessionFactory = sessionmaker(bind=get_engine())
st.set_page_config(page_title="AI RPG GM", layout="centered")
st.title("üéÆ AI RPG Game Master")

# --- Initialize Session State ---
if "screen" not in st.session_state:
    st.session_state.screen = "home"
    st.session_state.session_id = None
    st.session_state.messages = []

# --- UI View Functions ---

def show_home_screen():
    with SessionFactory() as db:
        sessions = db.query(SessionModel).order_by(SessionModel.id).all()
        session_map = {f"{s.id} - {s.genre} ({s.tone})": s.id for s in sessions}
        st.subheader("Start or Continue a Game")
        
        # Ensure there's a default value for the selectbox
        options = ["‚Äî New Game ‚Äî"] + list(session_map.keys())
        selected = st.selectbox("Choose a session:", options)

        if st.button("Continue"):
            if selected == "‚Äî New Game ‚Äî":
                st.session_state.screen = "session_zero"
                st.session_state.messages = [{"role": "assistant", "content": "Welcome to Session Zero! Let's create our world together. To start, what kind of adventure are you in the mood for?"}]
            else:
                # --- FIX: Load the selected game ---
                st.session_state.session_id = session_map[selected]
                st.session_state.screen = "game"
                # Load existing turns into the message history
                st.session_state.messages = []
                turns = db.query(Turn).filter_by(session_id=st.session_state.session_id).order_by(Turn.turn_number).all()
                for turn in turns:
                    st.session_state.messages.append({"role": "user", "content": turn.player_input})
                    st.session_state.messages.append({"role": "assistant", "content": turn.gm_response})
            st.rerun()

def show_session_zero_ui():
    st.subheader("üé≤ New Game: Session Zero")
    
    # ... (This function remains the same as the last version)
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    if prompt := st.chat_input("What do you say?"):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        with st.chat_message("assistant"):
            with st.spinner("GM is thinking..."):
                with SessionFactory() as db:
                    response = run_session_zero_turn(db, st.session_state.messages)
                    st.markdown(response)
        
        st.session_state.messages.append({"role": "assistant", "content": response})

        if "Success: World and character" in response:
            st.success("Your new adventure is ready! Go back to the main menu to load it.")
            if st.button("Back to Main Menu"):
                st.session_state.screen = "home"
                st.rerun()

# --- NEW: Gameplay Screen ---
def show_game_screen():
    st.subheader("‚öîÔ∏è Adventure in Progress")
    
    # Display existing messages from history
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # Get new player input
    if prompt := st.chat_input("What do you do?"):
        # Add player message to history and display it
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # Generate and display the AI's response
        with st.chat_message("assistant"):
            with st.spinner("GM is thinking..."):
                with SessionFactory() as db:
                    response = run_game_turn(db, st.session_state.session_id, prompt)
                    st.markdown(response)
        
        # Add AI response to history
        st.session_state.messages.append({"role": "assistant", "content": response})
        st.rerun()

# --- Main App Router ---
if st.session_state.screen == "home":
    show_home_screen()
elif st.session_state.screen == "session_zero":
    show_session_zero_ui()
elif st.session_state.screen == "game":
    show_game_screen()